USE MASTER 
GO

--PREGUNTA 01:
-- validación de existencia de base de datos
IF DB_ID('MASTER_PC') IS NOT NULL
	DROP DATABASE MASTER_PC
GO

CREATE DATABASE MASTER_PC
ON PRIMARY 
(
NAME = 'MASTER_PC_PRI',
FILENAME = 'C:\MASTER PC\BD\MASTER_PC.MDF',
SIZE = 6 MB,
MAXSIZE = UNLIMITED,
FILEGROWTH = 4 MB
)
LOG ON
(
NAME = 'MASTER_PC_SEC',
FILENAME = 'C:\MASTER PC\BD\MASTER_PC.NDF',  
SIZE = 7 MB,
MAXSIZE = 20 MB,
FILEGROWTH = 5%
),
(
NAME = 'MASTER_PC_TRA',
FILENAME = 'C:\MASTER PC\BD\MASTER_PC.LDF',  
SIZE = 7 MB,
MAXSIZE = 50 MB,
FILEGROWTH = 2 MB
)

GO

--PREGUNTA 02:
--definimos formato de fecha
SET DATEFORMAT DMY
GO

--creando tablas
USE MASTER_PC
GO

IF OBJECT_ID('SUCURSAL') IS NOT NULL
BEGIN
DROP TABLE SUCURSAL
END

CREATE TABLE SUCURSAL(
COD_SUC CHAR(6) NOT NULL,
DES_SUC VARCHAR(50) NOT NULL
)
GO


IF OBJECT_ID('HARDWARE') IS NOT NULL
BEGIN
DROP TABLE HARDWARE
END

CREATE TABLE HARDWARE(
COD_HAR CHAR(6) NOT NULL,
DES_HAR VARCHAR(50) NOT NULL,
PRECIO_HAR MONEY NOT NULL,
STOCK_HAR INT NOT NULL,
FEC_FAB DATE NOT NULL
)
GO

IF OBJECT_ID('VENDEDOR') IS NOT NULL
BEGIN
DROP TABLE VENDEDOR
END

CREATE TABLE VENDEDOR(
COD_VEN CHAR(6) NOT NULL,
COD_SUC CHAR(6) NOT NULL,
NOM_VEN VARCHAR(15) NOT NULL,
APE_PAT_VEN VARCHAR(15) NOT NULL,
APE_MAT_VEN VARCHAR(15) NOT NULL,
FEC_ING DATE NOT NULL,
DNI_VEN INT NOT NULL,
)
GO

IF OBJECT_ID('BOLETA') IS NOT NULL
BEGIN
DROP TABLE BOLETA
END

CREATE TABLE BOLETA(
COD_BOL CHAR(5) NOT NULL,
COD_VEN CHAR(6) NOT NULL,
FEC_BOL DATE NOT NULL,
EST_BOL VARCHAR(10) NOT NULL
)
GO


IF OBJECT_ID('DETALLE_BOLETA') IS NOT NULL
BEGIN
DROP TABLE DETALLE_BOLETA
END

CREATE TABLE DETALLE_BOLETA(
COD_BOL CHAR(5) NOT NULL, 
COD_HAR CHAR(6) NOT NULL,
CANT_BOL INT NOT NULL,
PRECIO_BOL MONEY NOT NULL
)
GO

-- pk
ALTER TABLE SUCURSAL ADD CONSTRAINT PK_COD_SUC PRIMARY KEY(COD_SUC)
GO
ALTER TABLE HARDWARE ADD CONSTRAINT PK_COD_HAR PRIMARY KEY(COD_HAR)
ALTER TABLE VENDEDOR ADD CONSTRAINT PK_COD_VEN PRIMARY KEY(COD_VEN)
ALTER TABLE BOLETA ADD CONSTRAINT PK_COD_BOL PRIMARY KEY(COD_BOL)
ALTER TABLE DETALLE_BOLETA ADD CONSTRAINT PK_COD_BOL_HAR PRIMARY KEY(COD_BOL, COD_HAR)
GO
-- fk
ALTER TABLE VENDEDOR ADD CONSTRAINT FK_VENDEDOR_SUCURSAL FOREIGN KEY (COD_SUC)
REFERENCES SUCURSAL(COD_SUC)
ALTER TABLE BOLETA ADD CONSTRAINT FK_BOLETA_VENDEDOR FOREIGN KEY (COD_VEN)
REFERENCES VENDEDOR(COD_VEN)
ALTER TABLE DETALLE_BOLETA ADD CONSTRAINT FK_DETALLEBOL_HARDWARE FOREIGN KEY (COD_HAR)
REFERENCES HARDWARE(COD_HAR)
ALTER TABLE DETALLE_BOLETA ADD CONSTRAINT FK_DETALLEBOL_BOLETA FOREIGN KEY (COD_BOL)
REFERENCES BOLETA(COD_BOL)
GO

--PREGUNTA 03:
-- insertando datos a cada una de las tablas
INSERT INTO SUCURSAL VALUES ('SUC001','LOS OLIVOS')
INSERT INTO SUCURSAL VALUES ('SUC002','LA VICTORIA')
INSERT INTO SUCURSAL VALUES ('SUC003','BREÑA')
INSERT INTO SUCURSAL VALUES ('SUC004','LINCE')

SELECT * FROM SUCURSAL
GO --verificando

INSERT INTO HARDWARE VALUES ('HAR001', 'MEMORIA RAM 8GB', '150.00', '20', '20/11/2022')
INSERT INTO HARDWARE VALUES ('HAR002', 'DISCO DURO 1 TB', '200.00', '15', '24/07/2021')
INSERT INTO HARDWARE VALUES ('HAR003', 'TARJETA DE VIDEO 2GB', '400.00', '25', '15/07/2022')
INSERT INTO HARDWARE VALUES ('HAR004', 'PARLANTE LG', '100.00', '10', '09/10/2022')

SELECT * FROM HARDWARE
GO


INSERT INTO VENDEDOR VALUES ('VEN001','SUC001', 'JOSE LUIS' , 'RAMOS', 'PALACIOS', '20/12/2018', 72200148 )
INSERT INTO VENDEDOR VALUES ('VEN002','SUC002', 'JUAN ALBERTO' , 'HI', 'LOPEZ', '23/12/2018', 46240142 )
INSERT INTO VENDEDOR VALUES ('VEN003','SUC004', 'ALFREDO' , 'DE LA TORRE', 'HUACCAC', '19/12/2018', 52290341 )
INSERT INTO VENDEDOR VALUES ('VEN004','SUC003', 'ANDY CARTHLON' , 'AZAÑEDO', 'AGUINAGA', '11/06/2021', 57903199 )

SELECT * FROM VENDEDOR
GO

INSERT INTO BOLETA VALUES ('BOL01','VEN001','06/06/2022', 'CANCELADO' )
INSERT INTO BOLETA VALUES ('BOL02','VEN001','03/03/2021', 'CANCELADO' )
INSERT INTO BOLETA VALUES ('BOL03','VEN002','07/05/2020', 'POR PAGAR' )
INSERT INTO BOLETA VALUES ('BOL04','VEN004','18/06/2022', 'CANCELADO' )


SELECT * FROM BOLETA
GO

INSERT INTO DETALLE_BOLETA VALUES ('BOL01','HAR001',2, '300.00' )
INSERT INTO DETALLE_BOLETA VALUES ('BOL02','HAR003',1, '400.00' )
INSERT INTO DETALLE_BOLETA VALUES ('BOL03','HAR001',4, '600.00' )
INSERT INTO DETALLE_BOLETA VALUES ('BOL04','HAR004',3, '300.00' )

SELECT * FROM DETALLE_BOLETA
GO

--PREGUNTA 04:
-- restricciones 

SELECT * FROM HARDWARE 
GO

ALTER TABLE HARDWARE ADD CONSTRAINT DF_PRECIO_HAR DEFAULT '0' FOR PRECIO_HAR
--verificando
INSERT INTO HARDWARE (COD_HAR, DES_HAR, STOCK_HAR, FEC_FAB) VALUES ('HAR005', 'MOUSE LOGITECH', '4', '22/03/2022')
SELECT * FROM HARDWARE 

--una restricción que permita registrar datos únicos
ALTER TABLE SUCURSAL ADD UNIQUE (DES_SUC)
GO

--2 restricciones más
SELECT * FROM BOLETA
ALTER TABLE  BOLETA ADD CONSTRAINT CHK_EST_BOL CHECK (EST_BOL IN ('CANCELADO', 'POR PAGAR'))

SELECT * FROM VENDEDOR
ALTER TABLE VENDEDOR ADD UNIQUE (DNI_VEN)



--PREGUNTA 05:
SELECT NOM_VEN AS 'NOMBRE' ,APE_PAT_VEN AS 'APELLIDO', FEC_ING AS 'FECHA DE INGRESO' , COD_VEN AS 'CODIGO'
FROM VENDEDOR WHERE FEC_ING >= '01/12/2018' AND FEC_ING <= '31/12/2018' ORDER BY FEC_ING DESC 


--PREGUNTA 06:
-- un script de una promoción que afecte el precio de los productos de hardware, debe contener 3 condiciones

SELECT * FROM HARDWARE

SELECT 
COD_HAR AS 'CODIGO',
DES_HAR AS 'PRODUCTO',
PRECIO_HAR AS 'PRECIO ACTUAL',
PRECIO_HAR * 0.33 AS 'PRECIO PROMOCION',
STOCK_HAR AS 'STOCK',
FEC_FAB AS 'FECHA DE FABRICACION' INTO PROMOCION_BK FROM HARDWARE 
/*Se aplicará una promoción a los nuevos productos fabricados que llegarán a partir de la fecha actual
de los que su stock fuese mayor igual a 15, su precio esté entre 100 y menor a 300 soles , entonces el precio se rebajará a su tercera parte.
*/
WHERE PRECIO_HAR >=100 AND PRECIO_HAR <300 AND STOCK_HAR >=15 AND FEC_FAB > GETDATE()
SELECT * FROM PROMOCION_BK --visualizando